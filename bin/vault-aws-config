#!/bin/zsh

zparseopts tls-skip-verify=TLS_SKIP_VERIFY path=HAS_PATH

CLUSTER=$(kubectl config current-context)

if [[ "$HAS_PATH" != "" ]]; then
  VAULT_PATH=aws/$CLUSTER
  PATH_PARAM="-path=$VAULT_PATH"
else
  VAULT_PATH=aws
  PATH_PARAM="-path=aws"
fi

vault secrets list $TLS_SKIP_VERIFY | grep -q "^$VAULT_PATH"
if [ $? -eq 0 ]; then
  echo "Aws auth backend already exists."
  exit 0
fi

set -e

AWS_ACCOUNT_ID=$(aws sts get-caller-identity --output text --query 'Account')

VAULT_USER="vault-$CLUSTER"

vault secrets enable $TLS_SKIP_VERIFY $PATH_PARAM aws

aws iam create-user --user "$VAULT_USER"

cat <<-EOF > /tmp/vault-aws-policy.json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "iam:AttachUserPolicy",
        "iam:CreateAccessKey",
        "iam:CreateUser",
        "iam:DeleteAccessKey",
        "iam:DeleteUser",
        "iam:DeleteUserPolicy",
        "iam:DetachUserPolicy",
        "iam:ListAccessKeys",
        "iam:ListAttachedUserPolicies",
        "iam:ListGroupsForUser",
        "iam:ListUserPolicies",
        "iam:PutUserPolicy",
        "iam:RemoveUserFromGroup"
      ],
      "Resource": [
        "arn:aws:iam:::user/vault-*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "sts:GetFederationToken"
      ],
      "Resource": [
        "*"
      ]
    }
  ]
}
EOF

ARN=$(aws iam list-policies |
  jq -r '.Policies[] | select(.PolicyName=="vault-user-policy") | .Arn')
if [[ "$ARN" == "" ]]; then
  ARN=$(aws iam create-policy --policy-name vault-user-policy \
    --policy-document file:///tmp/vault-aws-policy.json |
    jq -r '.Policy.Arn')
fi

aws iam attach-user-policy --user-name $VAULT_USER --policy-arn $ARN

ACCESS_KEY=$(aws iam create-access-key --user-name $VAULT_USER)

AWS_ACCESS_KEY_ID=$(echo $ACCESS_KEY | jq -r '.AccessKey.AccessKeyId')
AWS_SECRET_ACCESS_KEY=$(echo $ACCESS_KEY | jq -r '.AccessKey.SecretAccessKey')

vault write $TLS_SKIP_VERIFY $VAULT_PATH/config/root \
  access_key=$AWS_ACCESS_KEY_ID \
  secret_key=$AWS_SECRET_ACCESS_KEY \
  region=$AWS_DEFAULT_REGION
